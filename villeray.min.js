const d=[];export async function mount(t,e){const n=document.body.querySelector(t);n===null?console.log(new Error(`no match for '${t}' in document body`)):(d.push({elem:n,app:e}),await refresh())}let c=[];export async function refresh(){for(const t of d){const e=t.elem.activeElement?.id??"",n=await f(t.app());t.elem=await y(t.elem,n),A(t.elem,e),await Promise.all(c.map(r=>r())),c=[]}}function A(t,e){if(e!==""){const n=t.getElementById(e),r=t.activeElement??document.body;if(n===null)return;const o=n.onfocus,s=r.onblur;delete n.onfocus,delete r.onfocus,n.focus(),n.onfocus=o,r.onblur=s}}class p{constructor(e,n,r){var o;if(Object.assign(this,{tag:e,attrs:n,children:r}),e==="a"){const s=g(n.href??"",n.params??{});this.attrs={...n,href:s},n.href===void 0&&((o=this.attrs).onclick??(o.onclick=a=>{a.ctrlKey||a.shiftKey||a.metaKey||(setParams(n.params??{}),a.preventDefault())}))}}}function E(t){t.vnodeAttrs?.aftercreate&&c.push(()=>t.vnodeAttrs.aftercreate(t))}function w(t){t.vnodeAttrs?.afterremove&&c.push(()=>t.vnodeAttrs.afterremove(t))}function O(t){t.vnodeAttrs?.afterupdate&&c.push(()=>t.vnodeAttrs.afterupdate(t))}export function h(t,e,...n){if(typeof t!="string"){const r="error: 'tag' must be a string";return console.log(new Error(r),t),`(${r})`}if(typeof e!="object"){const r="error: 'attrs' must be an object";return console.log(new Error(r),t),`(${r})`}return new p(t,e,n)}function j(t,e){return e instanceof Function?`[function ${e.name}]`:e}async function f(t){switch(t?.constructor){case p:return t;case String:case Number:return String(t);case Boolean:case void 0:return"";case Promise:return f(await t);default:return h("pre",{},JSON.stringify(t,j,2))}}async function y(t,e){return typeof e=="string"?t.nodeType===Node.TEXT_NODE?(t.textContent!==e&&(t.textContent=e),t):m(t,await u(e)):e.tag.toUpperCase()===t.tagName?(await b(t,e),O(t),t):m(t,await u(e))}function m(t,e){return t.replaceWith(e),w(t),e}async function N(t,e){const n=t.vnodeAttrs??{};t.vnodeAttrs=e;for(const[r,o]of Object.entries(e))if(r.startsWith("on")&&n[r]!==o){switch(r){case"aftercreate":case"afterupdate":case"afterremove":continue}t[r]=async(...s)=>{await o(...s),await refresh()}}else if(r==="style"&&typeof o=="object"){const s=n.style??{};for(const[a,l]of Object.entries(o))s[a]!==l&&(t.style[a]=l);for(const a of Object.values(s))Object.hasOwnProperty.call(o,a)||t.style.removeProperty(a)}else t[r]!==o&&(t[r]=o);for(const r of Object.keys(n))Object.hasOwnProperty.call(e,r)||delete t[r]}async function v(t,e){const n=await Promise.all(e.map(f));let r=n.length,o=t.childNodes.length;for(let s=0;s<r;s++)s<o?await y(t.childNodes[s],n[s]):(t.append(await u(n[s])),o++);for(;o>r;){const s=t.childNodes[--o];t.removeChild(s),w(t)}}async function b(t,e){await N(t,e.attrs),await v(t,e.children)}let i=!1;async function u(t){if(typeof t=="string")return document.createTextNode(t);const e=i;i||(i=t.tag.toUpperCase()==="SVG");const n=i?document.createElementNS("http://www.w3.org/2000/svg",t.tag):document.createElement(t.tag);return await b(n,t),E(n),i=e,n}export function getParams(){return Object.fromEntries(new URL(window.location.href).searchParams.entries())}function g(t,e){const n=new URL(t,window.location.href);n.search="";for(const r of Object.keys(e).sort())n.searchParams.set(r,e[r]);return n}export async function setParams(t,e=!0){const n=g("",t);window.location.href!==n.href&&(e?window.history.pushState({},"",n):window.history.replaceState({},"",n)),await refresh()}function S(){let t="";async function e(){const n=window.location.href;n!==t&&(t=n,await refresh()),requestAnimationFrame(e)}e()}S();
