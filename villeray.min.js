const d=[];export async function mount(t,e){const n=document.body.querySelector(t);n===null?console.log(new Error(`no match for '${t}' in document body`)):(d.push({elem:n,app:e}),await refresh())}let a=[];export async function refresh(){for(const t of d){const e=t.elem.activeElement?.id??"",n=await u(t.app());t.elem=await y(t.elem,n),A(t.elem,e),await Promise.all(a.map(r=>r())),a=[]}}function A(t,e){if(e!==""){const n=t.getElementById(e),r=t.activeElement??document.body;if(n===null)return;const s=n.onfocus,o=r.onblur;delete n.onfocus,delete r.onfocus,n.focus(),n.onfocus=s,r.onblur=o}}class p{constructor(e,n,r){var s;if(this.tag=e,this.attrs=n,this.children=r,e==="a"){const o=b(n.href??"",n.params??{});this.attrs={...n,href:o},n.href===void 0&&((s=this.attrs).onclick??(s.onclick=c=>{c.ctrlKey||c.shiftKey||c.metaKey||(setParams(n.params??{}),c.preventDefault())}))}}}function N(t){t.vnodeAttrs?.aftercreate&&a.push(()=>t.vnodeAttrs.aftercreate(t))}function w(t){t.vnodeAttrs?.afterremove&&a.push(()=>t.vnodeAttrs.afterremove(t))}function S(t){t.vnodeAttrs?.afterupdate&&a.push(()=>t.vnodeAttrs.afterupdate(t))}export function h(t,e,...n){if(typeof t!="string"){const r="error: 'tag' must be a string";return console.log(new Error(r),t),`(${r})`}if(e?.constructor!==Object){const r="error: 'attrs' must be an object";return console.log(new Error(r),t),`(${r})`}return new p(t,e,n)}function E(t,e){return e instanceof Function?`[function ${e.name}]`:e}async function u(t){switch(t?.constructor){case p:return t;case String:case Number:return t.toString();case Boolean:case void 0:return"";case Promise:return u(await t);default:{const e=t.toString!==Object.prototype.toString?t.toString():JSON.stringify(t,E,2);return h("pre",{},e)}}}async function y(t,e){return typeof e=="string"?t.nodeType===Node.TEXT_NODE?(t.textContent!==e&&(t.textContent=e),t):m(t,await f(e)):e.tag.toUpperCase()===t.tagName?(await g(t,e),S(t),t):m(t,await f(e))}function m(t,e){return t.replaceWith(e),w(t),e}async function j(t,e){const n=t.vnodeAttrs??{};t.vnodeAttrs=e;for(const[r,s]of Object.entries(e))if(r.startsWith("on")){switch(r){case"aftercreate":case"afterupdate":case"afterremove":continue}n[r]!==s&&(t[r]=async(...o)=>{await s(...o),await refresh()})}else if(r==="class"){const o=[r].flat();t.className=o.join(" ")}else if(r==="style"&&s?.constructor!==Object){const o=n.style??{};for(const[c,l]of Object.entries(s))o[c]!==l&&(t.style[c]=l);for(const c of Object.values(o))s[c]==null&&t.style.removeProperty(c)}else t[r]!==s&&(t[r]=s);for(const r of Object.keys(n))e[r]==null&&delete t[r];e.class==null&&(t.className="")}async function v(t,e){const n=await Promise.all(e.map(u));let r=n.length,s=t.childNodes.length;for(let o=0;o<r;o++)o<s?await y(t.childNodes[o],n[o]):(t.append(await f(n[o])),s++);for(;s>r;){const o=t.childNodes[--s];t.removeChild(o),w(t)}}async function g(t,e){await j(t,e.attrs),await v(t,e.children)}let i=!1;async function f(t){if(typeof t=="string")return document.createTextNode(t);const e=i;i||(i=t.tag.toUpperCase()==="SVG");const n=i?document.createElementNS("http://www.w3.org/2000/svg",t.tag):document.createElement(t.tag);return await g(n,t),N(n),i=e,n}export function getParams(){return Object.fromEntries(new URL(window.location.href).searchParams.entries())}function b(t,e){const n=new URL(t,window.location.href);n.search="";for(const r of Object.keys(e).sort())n.searchParams.set(r,e[r]);return n}export async function setParams(t,e=!0){const n=b("",t);window.location.href!==n.href&&(e?window.history.pushState({},"",n):window.history.replaceState({},"",n)),await refresh()}function O(){let t="";async function e(){const n=window.location.href;n!==t&&(t=n,await refresh()),requestAnimationFrame(e)}e()}O();
